<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Effect Row Mobile Preview</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Manrope:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: radial-gradient(circle at 18% 18%, rgba(99, 76, 164, 0.32), transparent 32%),
            radial-gradient(circle at 86% 20%, rgba(61, 180, 175, 0.26), transparent 32%),
            linear-gradient(145deg, #0c0f1a 0%, #0d111f 42%, #0a0c15 100%);
      --panel: #101425;
      --panel-2: #0f1321;
      --card: linear-gradient(150deg, rgba(255, 255, 255, 0.04), rgba(255, 255, 255, 0.01));
      --stroke: rgba(255, 255, 255, 0.10);
      --text: #f5f7ff;
      --muted: #9aa3c2;
      --accent: #b18cff;
      --accent-2: #7dd0c3;
      --warning: #f4c06a;
      --danger: #e6767a;
      --good: #6ed9a7;
      --radius: 16px;
      --shadow: 0 14px 36px rgba(0, 0, 0, 0.38);
      --pill-h: 26px;
      --gap: 14px;
      color-scheme: dark;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 18px;
      font-family: "Space Grotesk", "Manrope", system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    .shell {
      max-width: 520px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    header h1 {
      margin: 0 0 6px;
      font-size: 1.35rem;
      letter-spacing: -0.01em;
    }

    header p {
      margin: 0;
      color: var(--muted);
      font-size: 0.96rem;
      line-height: 1.4;
    }

    .card-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 14px;
    }

    .effect-card {
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      padding: 14px;
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .row-header {
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: start;
      gap: 10px;
    }

    .titles {
      display: grid;
      gap: 4px;
      min-width: 0;
    }

    .eyebrow {
      font-size: 0.75rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .title {
      font-size: 1.02rem;
      font-weight: 700;
      letter-spacing: -0.01em;
      display: inline-flex;
      gap: 8px;
      align-items: center;
      min-width: 0;
    }

    .title .chip {
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.06);
      border: 1px solid rgba(255, 255, 255, 0.12);
      font-size: 0.72rem;
      color: var(--muted);
      line-height: 1;
    }

    .subtext {
      color: var(--muted);
      margin: 0;
      font-size: 0.92rem;
      line-height: 1.35;
    }

    .row-body {
      display: grid;
      gap: 8px;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      height: var(--pill-h);
      padding: 0 12px;
      border-radius: 999px;
      border: 1px solid transparent;
      font-weight: 700;
      font-size: 0.82rem;
      letter-spacing: 0.01em;
      line-height: 1;
      white-space: nowrap;
    }

    .pill.muted { color: var(--muted); border-color: rgba(255,255,255,0.12); background: rgba(255,255,255,0.04); }
    .pill.good { color: var(--chip-self-stack-yes-text); background: var(--chip-self-stack-yes-bg); border-color: var(--chip-self-stack-yes-border); }
    .pill.warn { color: var(--chip-curse-yes-text); background: var(--chip-curse-yes-bg); border-color: var(--chip-curse-yes-border); }
    .pill.bad { color: var(--chip-self-stack-no-text); background: var(--chip-self-stack-no-bg); border-color: var(--chip-self-stack-no-border); }

    .button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid var(--btn-instructions-border);
      background: var(--btn-instructions-bg);
      color: var(--btn-instructions-text);
      box-shadow: var(--btn-instructions-shadow);
      font-weight: 760;
      font-size: 0.98rem;
      cursor: pointer;
      transition: transform 120ms ease, filter 120ms ease, border-color 120ms ease;
      min-height: 44px;
      width: 100%;
    }

    .button.secondary {
      background: var(--chip-placeholder-bg);
      border-color: var(--chip-placeholder-border);
      color: var(--chip-placeholder-text);
      font-weight: 700;
    }

    .button.curse {
      background: var(--btn-instructions-bg);
      border-color: var(--btn-instructions-border);
      color: var(--btn-instructions-text);
      font-weight: 760;
      box-shadow: var(--btn-instructions-shadow);
    }

    .button.compact {
      padding: 10px 12px;
      min-height: 38px;
      width: auto;
    }

    .button:active { transform: translateY(1px); filter: var(--btn-instructions-active-filter); }
    .button:hover { filter: var(--btn-instructions-hover-filter); border-color: var(--btn-instructions-hover-border); }

    .validation {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .state-label {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: var(--muted);
      font-size: 0.9rem;
    }

    .icon-block {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 8px;
      width: 100%;
    }

    .icon-btn {
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      display: grid;
      place-items: center;
      height: 44px;
      cursor: pointer;
      color: var(--text);
      font-weight: 720;
      position: relative;
    }

    .icon-btn span { font-size: 0.9rem; letter-spacing: 0.01em; }

    .icon-btn::after {
      content: attr(data-label);
      position: absolute;
      inset: auto auto -22px 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.76);
      color: var(--text);
      padding: 4px 8px;
      border-radius: 8px;
      font-size: 0.72rem;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 120ms ease, transform 120ms ease;
    }

    .icon-btn:hover::after { opacity: 1; transform: translate(-50%, 2px); }

    .row-stack {
      display: grid;
      gap: 8px;
      background: rgba(255, 255, 255, 0.02);
      border: 1px dashed rgba(255, 255, 255, 0.08);
      border-radius: 12px;
      padding: 10px 12px;
    }

    .row-line {
      display: grid;
      gap: 4px;
      align-items: start;
    }

    .line-header {
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .line-title {
      font-weight: 760;
      font-size: 0.98rem;
      letter-spacing: -0.01em;
      min-width: 0;
      margin: 0;
      color: var(--accent);
      font-style: italic;
    }

    .meta-row {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .meta-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 0.24rem 0.6rem;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(32, 36, 44, 0.85);
      font-weight: 800;
      font-size: 0.72rem;
      letter-spacing: 0.02em;
      text-transform: uppercase;
      white-space: nowrap;
    }

    .hint-row {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: var(--muted);
      font-size: 0.9rem;
    }

    .badge-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      display: inline-block;
      background: var(--muted);
    }
    .badge-dot[data-dot-kind="curse"] { background: var(--chip-curse-yes-bg); }

    .action-menu {
      position: relative;
      display: inline-flex;
      align-items: center;
      vertical-align: middle;
    }

    .settings-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 1.3em;
      height: 1.3em;
      border-radius: 50%;
      border: 1px solid rgba(255, 255, 255, 0.16);
      background: linear-gradient(135deg, #b35114 0%, #e07c2b 50%, #e07c2b 100%);
      color: #1b0e05;
      font-weight: 800;
      line-height: 1;
      padding: 0;
      cursor: pointer;
      transition: filter 120ms ease, transform 120ms ease, border-color 120ms ease;
    }

    .settings-btn:hover { filter: brightness(1.05); border-color: rgba(255, 255, 255, 0.26); }
    .settings-btn:active { transform: translateY(1px); }

    .action-flyout {
      position: absolute;
      top: 0;
      left: 110%;
      min-width: 200px;
      background: rgba(16, 20, 37, 0.96);
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 12px;
      box-shadow: 0 12px 28px rgba(0, 0, 0, 0.45);
      padding: 8px;
      display: none;
      z-index: 10;
    }

    .action-flyout.open { display: grid; gap: 6px; }

    .divider-curse {
      height: 2px;
      width: 100%;
      background: linear-gradient(90deg, rgba(255, 255, 255, 0.9) 0%, rgba(18, 18, 24, 0.2) 100%);
      border: 0;
      border-radius: 999px;
      margin: 8px 0 4px;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.35);
    }

    .flyout-item {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.08);
      color: var(--text);
      font-weight: 720;
      font-size: 0.9rem;
      cursor: pointer;
      transition: filter 120ms ease, border-color 120ms ease;
    }

    .flyout-item:hover { filter: brightness(1.05); border-color: rgba(255, 255, 255, 0.18); }

    .flyout-icon {
      width: 24px;
      height: 24px;
      display: grid;
      place-items: center;
      border-radius: 50%;
      font-weight: 760;
      font-size: 0.9rem;
      line-height: 1;
      color: var(--accent);
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.12);
    }

    .flyout-icon[data-tone="info"] { color: var(--accent); border-color: rgba(177, 140, 255, 0.65); }
    .flyout-icon[data-tone="swap"] { color: #6ba7ff; border-color: rgba(107, 167, 255, 0.7); }
    .flyout-icon[data-tone="danger"] { color: var(--danger); border-color: rgba(230, 118, 122, 0.75); }
    .flyout-icon[data-tone="copy"] { color: var(--accent-2); border-color: rgba(125, 208, 195, 0.7); }
    .flyout-icon[data-tone="muted"] { color: var(--chip-placeholder-text); border-color: var(--chip-placeholder-border); }

    /* Copy icon uses the same SVG as the main app's icon block */
    .flyout-icon.copy-icon {
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.28) 0%, rgba(24,38,32,0.9) 55%, rgba(16,26,22,0.9) 100%);
      border-color: rgba(90, 210, 140, 0.7);
      color: transparent;
      position: relative;
      overflow: hidden;
    }

    .flyout-icon.copy-icon::before {
      content: "";
      width: 12px;
      height: 12px;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%2336d27a'%3E%3Cpath d='M16 1H6a2 2 0 0 0-2 2v12h2V3h10V1Z'/%3E%3Cpath d='M18 5H10a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2Zm0 16H10V7h8v14Z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-size: contain;
      background-position: center;
      position: absolute;
      inset: 0;
      margin: auto;
    }

    @media (min-width: 641px) {
      body { padding: 32px; }
      .shell { max-width: 640px; }
    }
  </style>
</head>
<body>
  <main class="shell">
    <header>
      <h1>Effect Row — Mobile Preview</h1>
      <p>Four states shown in a single-width stack. Each row keeps a fixed validation slot on the right and uses a bottom action cluster for the Icon Block.</p>
    </header>

    <section class="card-grid" aria-label="Effect row states">
      <article class="effect-card">
        <div class="row-body">
          <button class="button">Select Effect</button>
        </div>
      </article>

      <article class="effect-card">
        <div class="row-header">
          <div class="titles">
            <div class="title">HP restored when using medicinal boluses, etc. +1
              <span class="action-menu">
                <button class="settings-btn" aria-haspopup="true" aria-expanded="false" aria-label="Effect actions" data-menu-id="effect-menu-1">⚙</button>
                <div class="action-flyout" data-menu="effect-menu-1" role="menu">
                  <button class="flyout-item" role="menuitem"><span class="flyout-icon" data-tone="swap">⇄</span>Change Effect</button>
                  <button class="flyout-item" role="menuitem"><span class="flyout-icon" data-tone="info">i</span>Information</button>
                  <button class="flyout-item" role="menuitem"><span class="flyout-icon" data-tone="danger">×</span>Clear Effect</button>
                  <button class="flyout-item" role="menuitem"><span class="flyout-icon copy-icon" data-tone="copy" aria-hidden="true"></span>Copy Effect ID</button>
                </div>
              </span>
            </div>
            <p class="subtext">Consuming an edible item restores 80 HP to the user.</p>
          </div>
          <div class="validation"><span class="pill good">Valid</span></div>
        </div>
        <div class="row-body">
          <div class="meta-row">
            <span class="meta-pill" data-kind="category" data-label="Restoration">Restoration</span>
            <span class="meta-pill" data-kind="self-stack" data-value="yes">Self-Stacking: Yes</span>
            <span class="meta-pill" data-kind="class" data-label="All">All</span>
            <span class="meta-pill" data-kind="relic" data-label="Depth Of Night" data-value="depth">Depth Of Night</span>
          </div>
        </div>
      </article>

      <article class="effect-card">
        <div class="row-header">
          <div class="titles">
            <div class="title">Partial HP Restoration upon Post-Damage Attacks +1
              <span class="action-menu">
                <button class="settings-btn" aria-haspopup="true" aria-expanded="false" aria-label="Effect actions" data-menu-id="effect-menu-2">⚙</button>
                <div class="action-flyout" data-menu="effect-menu-2" role="menu">
                  <button class="flyout-item" role="menuitem"><span class="flyout-icon" data-tone="swap">⇄</span>Change Effect</button>
                  <button class="flyout-item" role="menuitem"><span class="flyout-icon" data-tone="info">i</span>Information</button>
                  <button class="flyout-item" role="menuitem"><span class="flyout-icon" data-tone="danger">×</span>Clear Effect</button>
                  <button class="flyout-item" role="menuitem"><span class="flyout-icon copy-icon" data-tone="copy" aria-hidden="true"></span>Copy Effect ID</button>
                </div>
              </span>
            </div>
            <p class="subtext">Damage taken over the past 4 seconds can be healed by dealing damage. Curse required.</p>
          </div>
          <div class="validation"><span class="pill warn">Curse Required</span></div>
        </div>
        <div class="row-body">
          <div class="meta-row">
            <span class="meta-pill" data-kind="category" data-label="Restoration">Restoration</span>
            <span class="meta-pill" data-kind="self-stack" data-value="no">Self-Stacking: No</span>
            <span class="meta-pill" data-kind="class" data-label="All">All</span>
            <span class="meta-pill" data-kind="relic" data-label="Depth Of Night" data-value="depth">Depth Of Night</span>
          </div>
          <div class="divider-curse" aria-hidden="true"></div>
          <button class="button curse">Select Curse</button>
        </div>
      </article>

      <article class="effect-card">
        <div class="row-header">
          <div class="titles">
            <div class="title">Partial HP Restoration upon Post-Damage Attacks +1
              <span class="action-menu">
                <button class="settings-btn" aria-haspopup="true" aria-expanded="false" aria-label="Effect actions" data-menu-id="effect-menu-3">⚙</button>
                <div class="action-flyout" data-menu="effect-menu-3" role="menu">
                  <button class="flyout-item" role="menuitem"><span class="flyout-icon" data-tone="swap">⇄</span>Change Effect</button>
                  <button class="flyout-item" role="menuitem"><span class="flyout-icon" data-tone="info">i</span>Information</button>
                  <button class="flyout-item" role="menuitem"><span class="flyout-icon" data-tone="danger">×</span>Clear Effect</button>
                  <button class="flyout-item" role="menuitem"><span class="flyout-icon copy-icon" data-tone="copy" aria-hidden="true"></span>Copy Effect ID</button>
                </div>
              </span>
            </div>
            <p class="subtext">Damage taken over the past 4 seconds can be healed by dealing damage. Curse selected.</p>
          </div>
          <div class="validation"><span class="pill good">Valid</span></div>
        </div>
        <div class="row-body">
          <div class="meta-row">
            <span class="meta-pill" data-kind="category" data-label="Restoration">Restoration</span>
            <span class="meta-pill" data-kind="self-stack" data-value="no">Self-Stacking: No</span>
            <span class="meta-pill" data-kind="class" data-label="All">All</span>
            <span class="meta-pill" data-kind="relic" data-label="Depth Of Night" data-value="depth">Depth Of Night</span>
          </div>
          <div class="divider-curse" aria-hidden="true"></div>
          <div class="row-line">
            <div class="line-header">
              <p class="line-title">Taking Damage Causes Rot Buildup</p>
              <span class="action-menu">
                <button class="settings-btn" aria-haspopup="true" aria-expanded="false" aria-label="Curse actions" data-menu-id="curse-menu-1">⚙</button>
                <div class="action-flyout" data-menu="curse-menu-1" role="menu">
                  <button class="flyout-item" role="menuitem"><span class="flyout-icon" data-tone="swap">⇄</span>Change Curse</button>
                  <button class="flyout-item" role="menuitem"><span class="flyout-icon" data-tone="info">i</span>Information</button>
                  <button class="flyout-item" role="menuitem"><span class="flyout-icon" data-tone="danger">×</span>Clear Curse</button>
                  <button class="flyout-item" role="menuitem"><span class="flyout-icon copy-icon" data-tone="copy" aria-hidden="true"></span>Copy Curse ID</button>
                </div>
              </span>
            </div>
            <p class="subtext">Upon getting hit, recieve 44 scarlet rot buildup.</p>
          </div>
          <div class="meta-row">
            <span class="meta-pill" data-kind="category" data-label="Demerits (Damage Negation)">Demerits (Damage Negation)</span>
            <span class="meta-pill" data-kind="self-stack" data-value="yes">Self-Stacking: Yes</span>
            <span class="meta-pill" data-kind="class" data-label="All">All</span>
          </div>
        </div>
      </article>
    </section>
  </main>

  <script type="module">
    import { applyPaletteCssVars, CHIP_COLORS, RELIC_TYPE_COLORS, characterColors } from "./palette.js";
    import { categoryColorFor, gradientFromTheme, textColorFor } from "../../Reliquary/modules/theme.js";

    applyPaletteCssVars();

    const tokenForSelfStack = {
      yes: CHIP_COLORS.selfStackYes,
      no: CHIP_COLORS.selfStackNo,
      unknown: CHIP_COLORS.selfStackUnknown
    };

    const hexToRgba = (hex, alpha = 0.65) => {
      const sanitized = (hex || "").replace("#", "");
      const bigint = parseInt(sanitized, 16);
      if (Number.isNaN(bigint)) return `rgba(255, 255, 255, ${alpha})`;
      const r = (bigint >> 16) & 255;
      const g = (bigint >> 8) & 255;
      const b = bigint & 255;
      return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    };

    const setChipStyle = (el, token) => {
      if (!el || !token) return;
      if (token.bg) el.style.background = token.bg;
      if (token.border) el.style.borderColor = token.border;
      if (token.text) el.style.color = token.text;
    };

    const setThemeStyle = (el, label) => {
      if (!el || !label) return;
      const theme = categoryColorFor(label);
      if (!theme) return;
      const bg = gradientFromTheme(theme);
      const border = hexToRgba(theme.base || label, 0.65);
      const text = theme.text || textColorFor(theme.base || "#f7f9ff");
      el.style.background = bg;
      el.style.borderColor = border;
      el.style.color = text;
    };

    document.querySelectorAll("[data-kind]").forEach(el => {
      const kind = el.dataset.kind;
      const label = el.dataset.label || el.textContent.trim();
      if (!kind) return;

      if (kind === "category") {
        setThemeStyle(el, label);
        return;
      }

      if (kind === "self-stack") {
        const val = (el.dataset.value || "unknown").toLowerCase();
        setChipStyle(el, tokenForSelfStack[val] || tokenForSelfStack.unknown);
        return;
      }

      if (kind === "class") {
        const isAll = (label || "").toLowerCase() === "all";
        const chip = isAll ? CHIP_COLORS.characterAll : characterColors(label);
        setChipStyle(el, chip);
        return;
      }

      if (kind === "relic") {
        const val = (el.dataset.value || "").toLowerCase();
        const chip = RELIC_TYPE_COLORS[val] || RELIC_TYPE_COLORS.standard;
        setChipStyle(el, chip);
      }
    });

    document.querySelectorAll(".badge-dot[data-dot-kind='curse']").forEach(el => {
      el.style.background = CHIP_COLORS.curseYes.bg;
    });

    // Simple flyout toggles for the inline settings buttons
    const flyouts = new Map();
    document.querySelectorAll(".action-flyout").forEach(f => flyouts.set(f.dataset.menu, f));

    function closeAll() {
      flyouts.forEach(f => f.classList.remove("open"));
      document.querySelectorAll(".settings-btn").forEach(btn => btn.setAttribute("aria-expanded", "false"));
    }

    document.querySelectorAll(".settings-btn").forEach(btn => {
      const id = btn.dataset.menuId;
      const flyout = flyouts.get(id);
      if (!flyout) return;
      btn.addEventListener("click", evt => {
        evt.stopPropagation();
        const isOpen = flyout.classList.contains("open");
        closeAll();
        if (!isOpen) {
          flyout.classList.add("open");
          btn.setAttribute("aria-expanded", "true");
        }
      });
    });

    document.addEventListener("click", () => closeAll());
    document.addEventListener("keydown", e => {
      if (e.key === "Escape") closeAll();
    });
  </script>
</body>
</html>
